<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Club — Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">LC</div>
      <div class="brand-name">Loan Club — Admin</div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Admin Login</h2>
      <p class="muted">Enter admin password (Vercel `ADMIN_PASS`).</p>
      <div class="row" style="margin-top:10px">
        <input id="admin-pass" placeholder="Admin password" />
        <button id="btn-admin-login" class="btn btn-primary">Login</button>
      </div>
    </section>

    <section id="admin-panel" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Applications</h2>
        <div>
          <button id="btn-refresh" class="btn">Refresh</button>
          <button id="btn-export-admin" class="btn btn-outline">Export JSON</button>
          <input id="file-import-admin" type="file" accept=".json" style="display:none" />
          <button id="btn-import-admin" class="btn">Import JSON</button>
        </div>
      </div>
      <div id="admin-list" class="list" style="margin-top:12px"></div>
    </section>
  </main>

  <script>
  // inline admin.js — admin logic (requires ADMIN_PASS)
  const ADMIN_API = { load:'/api/load', save:'/api/save' };
  let DB = null, adminPass = null;
  const uid = (p='u') => p + '-' + Math.random().toString(36).slice(2,9);
  const byId = id => document.getElementById(id);

  async function loadData(pass){
    adminPass = pass;
    const res = await fetch(ADMIN_API.load);
    if (!res.ok) throw new Error('Load failed');
    DB = await res.json();
    renderAll();
  }
  async function saveData(newDb){
    if (!adminPass) return alert('Not logged in');
    const res = await fetch(ADMIN_API.save, {
      method: 'POST',
      headers: {'Content-Type':'application/json','x-admin-pass': adminPass},
      body: JSON.stringify({ content: newDb })
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Save failed');
    }
    DB = await res.json();
    renderAll();
  }

  function renderAll(){ renderList(); }
  function renderList(){
    const list = byId('admin-list'); list.innerHTML = '';
    if (!DB || !DB.applications || DB.applications.length===0) { list.innerHTML = '<div class="muted">No applications</div>'; return; }
    DB.applications.slice().reverse().forEach(app => {
      const d = document.createElement('div'); d.className='app-card';
      const statusCls = app.status === 'approved' ? 'status-approved' : app.status === 'rejected' ? 'status-rejected' : app.status === 'hold' ? 'status-hold' : 'status-pending';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between">
          <div><strong>$${app.requested} — ${app.purpose||''}</strong><div class="muted">by ${app.userName||'unknown'}</div></div>
          <div><span class="status-badge ${statusCls}">${app.status}</span></div>
        </div>
        <div class="muted" style="margin-top:8px">Created: ${app.createdAt ? new Date(app.createdAt).toLocaleString() : '-'}</div>
        <div class="muted" style="margin-top:8px">Admin comment: ${app.adminComment||'—'}</div>
      `;
      const ctrl = document.createElement('div'); ctrl.className='row';
      ['approve','hold','reject'].forEach(action => {
        const b = document.createElement('button'); b.className='btn'; b.innerText = action[0].toUpperCase()+action.slice(1);
        b.onclick = async () => {
          const comment = prompt('Add a comment for ' + action + ' (required)');
          if (comment === null) return;
          if (comment.trim()==='') { alert('Comment required'); return; }
          app.status = action === 'approve' ? 'approved' : action === 'reject' ? 'rejected' : 'hold';
          app.adminComment = comment.trim();
          app.adminAt = new Date().toISOString();
          try { await saveData(DB); } catch (err) { alert('Save failed: ' + (err.message || err)); }
        };
        ctrl.appendChild(b);
      });
      if (app.withdrawalRequested && !app.withdrawalCompleted) {
        const comp = document.createElement('button'); comp.className='btn'; comp.innerText='Mark Withdrawal Completed';
        comp.onclick = async () => {
          const ok = confirm(`Mark withdrawal for $${app.requested} as completed?`);
          if (!ok) return;
          app.withdrawalCompleted = true;
          app.withdrawalCompletedAt = new Date().toISOString();
          try { await saveData(DB); } catch (err) { alert('Save failed: ' + (err.message || err)); }
        };
        ctrl.appendChild(comp);
      }
      d.appendChild(ctrl);
      list.appendChild(d);
    });
  }

  // export/import
  function setupImportExport() {
    byId('btn-export-admin').onclick = () => {
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(DB, null,2)], {type:'application/json'}));
      a.download = 'loanclub-data.json'; a.click();
    };
    byId('btn-import-admin').onclick = () => byId('file-import-admin').click();
    byId('file-import-admin').onchange = async e => {
      const f = e.target.files[0]; if (!f) return;
      const txt = await f.text();
      try {
        const parsed = JSON.parse(txt);
        if (!confirm('Overwrite repo data.json with uploaded file?')) return;
        await saveData(parsed);
        alert('Imported and saved.');
      } catch (err) { alert('Invalid JSON'); }
    };
  }

  // wire login / refresh
  byId('btn-admin-login').onclick = async () => {
    const pass = byId('admin-pass').value.trim();
    if (!pass) return alert('Enter admin password');
    try {
      await loadData(pass);
      document.getElementById('admin-panel').classList.remove('hidden');
      byId('btn-admin-login').disabled = true;
      byId('admin-pass').value = '';
      setupImportExport();
    } catch (err) {
      alert('Login failed: ' + (err.message || err));
    }
  };
  byId('btn-refresh').onclick = async () => {
    if (!adminPass) return alert('Not logged in');
    try { await loadData(adminPass); } catch (err) { alert('Refresh failed'); }
  };
  </script>
</body>
</html>
