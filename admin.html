<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Club — Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* small admin-specific overrides */
    body{padding:22px;background:linear-gradient(180deg,var(--bgA),var(--bgB));}
    .admin-wrap{max-width:1200px;margin:0 auto;color:var(--text-light)}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .table{width:100%;border-collapse:collapse}
    .table th, .table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
    .table th{color:var(--text-muted);font-weight:700}
    .detail-panel{background:var(--bgCard);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);box-shadow:var(--shadow-soft)}
    .actions{display:flex;gap:8px}
    .admin-filter{display:flex;gap:8px;align-items:center}
    .search{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#0f1726;color:var(--text-light)}
    .status-pill{padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px}
    .status-pending{background:#4c4c12;color:#fff}
    .status-approved{background:#0e5d32;color:white}
    .status-rejected{background:#8c1a32;color:white}
    .status-hold{background:#28306d;color:white}
    .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
    .modal-card { width:100%; max-width:900px; border-radius:12px; padding:18px; background: linear-gradient(180deg,#0f1726,#081323); border:1px solid rgba(255,255,255,0.06); box-shadow: var(--shadow-strong); color:var(--text-light) }
    .field-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
    .field{flex:1;min-width:180px}
    .muted-small{color:var(--text-muted);font-size:13px}
    .comment-box{width:100%;height:90px;padding:10px;border-radius:8px;background:#07101b;border:1px solid rgba(255,255,255,0.06);color:var(--text-light)}
    .small-note{font-size:12px;color:var(--text-muted);margin-top:8px}
    /* small sign-out admin button */
    #adminKeyLogout { background: transparent; border:1px solid rgba(255,255,255,0.08); color:var(--text-light); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <div class="admin-wrap">
    <div class="admin-header">
      <div>
        <h1 style="margin:0">Loan Club — Admin</h1>
        <div class="muted-small">View and manage loan applications</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="admin-filter">
          <select id="filterStatus" class="search">
            <option value="">All statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="hold">Hold</option>
          </select>
          <input id="searchQ" placeholder="Search name or email or id" class="search" />
        </div>
        <button id="refreshBtn" class="btn btn-outline">Refresh</button>
        <button id="adminKeyLogout" title="Clear stored admin key">Sign out (admin)</button>
      </div>
    </div>

    <div id="listWrap">
      <table class="table">
        <thead>
          <tr>
            <th>Applicant</th>
            <th>Amount</th>
            <th>Term</th>
            <th>Submitted</th>
            <th>Status</th>
            <th style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody id="appsTbody"></tbody>
      </table>
    </div>

    <div id="empty" class="muted-small" style="margin-top:12px"></div>
  </div>

  <!-- Detail modal -->
  <div id="detailModal" class="modal hidden" style="z-index:2000">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div id="detailTitle" style="font-weight:900;font-size:18px"></div>
          <div id="detailSub" class="muted-small"></div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="closeDetail" class="btn btn-ghost">Close</button>
        </div>
      </div>

      <div id="detailBody" class="detail-panel">
        <!-- fields inserted dynamically -->
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:flex-start">
        <select id="adminAction" class="search" style="width:160px">
          <option value="approved">Approve</option>
          <option value="rejected">Reject</option>
          <option value="hold">Hold</option>
        </select>
        <textarea id="adminComment" placeholder="Add admin comment (optional)" class="comment-box"></textarea>
        <div style="display:flex;gap:8px">
          <button id="applyAction" class="btn btn-primary">Apply</button>
        </div>
      </div>

      <div class="small-note">Showing full applicant details (sensitive). Protect this admin page with authentication in production.</div>
    </div>
  </div>

<script>
(async function(){
  const loadUrl = '/api/load';
  const adminUrl = '/api/admin';
  let DB = null;
  let apps = [];
  let selectedApp = null;

  const $ = id => document.getElementById(id);
  const show = el => el && el.classList.remove('hidden');
  const hide = el => el && el.classList.add('hidden');

  function toast(msg){
    alert(msg);
  }

  /* ---------- ADMIN KEY HANDLING ---------- */
  function ensureAdminKeySync() {
    // If already present in sessionStorage, nothing to do
    if (sessionStorage.getItem('adminKey')) return true;

    // Prompt user for key (simple, immediate)
    let key = null;
    try { key = prompt('Enter Admin Key to access admin panel:'); } catch (e) { key = null; }

    if (!key) {
      alert('Admin key required to access this page. You will be redirected.');
      // Optional: redirect to home
      location.href = '/';
      return false;
    }
    sessionStorage.setItem('adminKey', key);
    return true;
  }

  // Clear admin key UI control
  const adminKeyLogoutBtn = document.getElementById('adminKeyLogout');
  if (adminKeyLogoutBtn) {
    adminKeyLogoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('adminKey');
      alert('Admin key cleared. You will be redirected to login.');
      location.reload();
    });
  }

  // Ensure key before doing anything sensitive
  if (!ensureAdminKeySync()) return;

  /* ---------- DATA LOADING ---------- */
  async function loadData(){
    try {
      const r = await fetch(loadUrl, {cache:'no-store'});
      if (!r.ok) throw new Error('load failed');
      DB = await r.json();
      apps = (DB.applications || []).slice();
      renderList();
    } catch (err) {
      console.error(err);
      toast('Could not load data.json — check server logs or network. If you see a 401, ensure your ADMIN_KEY is correct on the server and in this prompt.');
    }
  }

  function formatDate(iso){
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  function renderList(){
    const tbody = $('appsTbody');
    tbody.innerHTML = '';
    const filter = $('filterStatus').value;
    const q = ($('searchQ').value || '').trim().toLowerCase();

    const list = apps.filter(a => {
      if (filter && a.status !== filter) return false;
      if (!q) return true;
      return (a.userName && a.userName.toLowerCase().includes(q)) ||
             (a.userEmail && a.userEmail.toLowerCase().includes(q)) ||
             (a.id && a.id.toLowerCase().includes(q));
    });

    if (!list.length) {
      $('empty').textContent = 'No applications found for the selected filter.';
    } else {
      $('empty').textContent = '';
    }

    list.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).forEach(a => {
      const tr = document.createElement('tr');

      const statusClass = a.status === 'approved' ? 'status-approved' : a.status === 'rejected' ? 'status-rejected' : a.status === 'hold' ? 'status-hold' : 'status-pending';

      tr.innerHTML = `
        <td>
          <div style="font-weight:800">${escapeHtml(a.userName||'—')}</div>
          <div class="muted-small">${escapeHtml(a.userEmail||'—')}</div>
          <div class="muted-small">${escapeHtml(a.id)}</div>
        </td>
        <td>$${Number(a.requested||0).toLocaleString()}</td>
        <td>${a.term || '-' } months</td>
        <td class="muted-small">${formatDate(a.createdAt)}</td>
        <td><div class="status-pill ${statusClass}">${escapeHtml(a.status)}</div></td>
        <td>
          <div class="actions">
            <button class="btn btn-outline btn-sm" data-id="${a.id}" data-action="view">View</button>
            <button class="btn btn-ghost btn-sm" data-id="${a.id}" data-action="download">JSON</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // attach click handlers
    tbody.querySelectorAll('button[data-action]').forEach(b => {
      b.addEventListener('click', (e) => {
        const id = b.getAttribute('data-id');
        const action = b.getAttribute('data-action');
        const app = apps.find(x => x.id === id);
        if (!app) return;
        if (action === 'view') openDetail(app);
        if (action === 'download') downloadJson(app);
      });
    });
  }

  function downloadJson(app){
    const data = JSON.stringify(app, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `application-${app.id}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function escapeHtml(str){
    if (!str && str !== 0) return '';
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function openDetail(app){
    selectedApp = app;
    $('detailTitle').textContent = `${app.userName || app.userEmail} — $${(app.requested||0).toLocaleString()}`;
    $('detailSub').textContent = `${formatDate(app.createdAt)} • ${app.id}`;
    const body = $('detailBody');
    body.innerHTML = '';

    // full details layout (show full sensitive fields to admin)
    const rows = [];
    rows.push({k:'Full name', v:app.userName || '—'});
    rows.push({k:'Email', v:app.userEmail || '—'});           // full email shown
    rows.push({k:'Phone', v:app.phone || '—'});               // full phone shown
    rows.push({k:'Address', v:app.address || '—'});           // full address shown
    rows.push({k:'Zip', v:app.zip || '—'});                   // full zip shown
    rows.push({k:'Requested', v:`$${(app.requested||0).toLocaleString()}`});
    rows.push({k:'Term (months)', v: app.term || '-'});
    rows.push({k:'Purpose', v: app.purpose || '—'});
    // Show full bank details (account number NOT masked for admin)
    rows.push({k:'Bank name', v: app.bank?.bankName || '—'});
    rows.push({k:'Account #', v: app.bank?.accountNumber || '—'}); // full account number shown
    rows.push({k:'Routing #', v: app.bank?.routingNumber || '—'});
    rows.push({k:'Account type', v: app.bank?.accountType || '—'});
    rows.push({k:'References', v: app.references || '—'});
    rows.push({k:'Status', v: app.status || 'pending'});
    rows.push({k:'Admin comment', v: app.adminComment || '—'});
    rows.push({k:'Application ID', v: app.id});
    rows.push({k:'Submitted at', v: formatDate(app.createdAt)});
    // append rows
    rows.forEach(r => {
      const el = document.createElement('div');
      el.className = 'field-row';
      el.innerHTML = `<div class="field" style="font-weight:700">${escapeHtml(r.k)}</div><div class="field muted-small">${escapeHtml(r.v)}</div>`;
      body.appendChild(el);
    });

    // prefill admin controls
    $('adminComment').value = app.adminComment || '';
    $('adminAction').value = app.status === 'approved' ? 'approved' : app.status === 'rejected' ? 'rejected' : app.status === 'hold' ? 'hold' : 'approved';

    show($('detailModal'));
  }

  function closeDetail(){
    selectedApp = null;
    hide($('detailModal'));
  }

  /* ---------- APPLY ADMIN ACTION (sends x-admin-key header) ---------- */
  async function applyAdminAction(){
    if (!selectedApp) return;
    const newStatus = $('adminAction').value;
    const comment = $('adminComment').value.trim();

    const adminKey = sessionStorage.getItem('adminKey') || '';
    if (!adminKey) {
      alert('Admin key missing — please sign in again.');
      location.reload();
      return;
    }

    const payload = { action: 'updateStatus', id: selectedApp.id, status: newStatus, adminComment: comment };

    try {
      const res = await fetch(adminUrl, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'x-admin-key': adminKey
        },
        body: JSON.stringify(payload)
      });

      if (res.status === 401) {
        // unauthorized — clear stored key and prompt again
        sessionStorage.removeItem('adminKey');
        alert('Invalid admin key (401). Please enter the correct key.');
        // re-run key prompt flow
        if (!ensureAdminKeySync()) return;
        return;
      }

      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || 'admin update failed');
      }

      const json = await res.json();
      // update local apps and refresh list
      apps = json.applications || apps;
      toast('Status updated');
      closeDetail();
      renderList();
    } catch (err) {
      console.error(err);
      toast('Could not update — check server logs or network. See console for details.');
    }
  }

  // wire UI controls
  $('refreshBtn').addEventListener('click', () => loadData());
  $('filterStatus').addEventListener('change', () => renderList());
  $('searchQ').addEventListener('input', () => renderList());
  $('closeDetail').addEventListener('click', closeDetail);
  $('applyAction').addEventListener('click', applyAdminAction);

  // initial load (ensure key present then fetch)
  await loadData();
})();
</script>
</body>
</html>
