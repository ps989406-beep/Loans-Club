<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Club ‚Äî Apply (Wizard fixed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
  <meta name="description" content="Loan Club ‚Äî wizard application (one-by-one)"/>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">LC</div>
        <div class="brand-text">
          <div class="brand-name">Loan Club</div>
          <div class="brand-sub">Simple ‚Ä¢ Transparent ‚Ä¢ Fast</div>
        </div>
      </div>
      <nav class="top-actions">
        <button id="loginOpen" class="btn btn-ghost">Login / Signup</button>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <main class="hero-wrap">
    <div class="hero-card">
      <div class="hero-left">
        <h1 class="hero-title">Get funds fast ‚Äî clear, simple terms</h1>
        <p class="hero-lead">Flat <strong>10% APR</strong> (simple interest). Apply in a few quick steps and track your application.</p>
        <div class="hero-ctas">
          <button id="applyOpen" class="btn btn-primary btn-xl">Apply Now</button>
          <button id="calcOpen" class="btn btn-outline">Loan Calculator</button>
        </div>
        <ul class="badges">
          <li>üîí Secure & encrypted</li>
          <li>‚ö° Quick review</li>
          <li>ü§ù Transparent fees</li>
        </ul>

        <div class="feature-grid">
          <div class="feature">
            <div class="feature-title">Fast decision</div>
            <div class="feature-desc muted">Quick demo review.</div>
          </div>
          <div class="feature">
            <div class="feature-title">Clear pricing</div>
            <div class="feature-desc muted">Flat 10% yearly simple interest.</div>
          </div>
          <div class="feature">
            <div class="feature-title">Secure payouts</div>
            <div class="feature-desc muted">Bank transfers.</div>
          </div>
        </div>
      </div>

      <aside class="hero-right">
        <div class="card calc-card">
          <div class="calc-title">Loan Calculator</div>
          <div class="calc-controls">
            <label>Amount<input id="calcAmt" type="number" min="100" step="50" value="5000"></label>
            <label>Term (months)<input id="calcTerm" type="number" min="1" max="60" value="12"></label>
          </div>
          <div class="calc-output">
            <div class="muted">Est. monthly (simple interest)</div>
            <div id="calcMonthly" class="calc-monthly">$0 / month</div>
            <div class="muted small">Flat 10% yearly. Estimate only.</div>
          </div>
        </div>

        <div class="trust-card">
          <div class="trust-title">Trusted by customers</div>
          <div class="trust-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <div class="muted small">Demo testimonials and secure experience.</div>
        </div>
      </aside>
    </div>

    <section class="testimonials card">
      <div class="test-col">
        <div class="quote">"Loan Club made it simple ‚Äî demo approval was fast."</div>
        <div class="who">‚Äî Jane D.</div>
      </div>
      <div class="test-col">
        <div class="quote">"Clear terms and easy tracking."</div>
        <div class="who">‚Äî Mark T.</div>
      </div>
      <div class="test-col">
        <div class="quote">"Support was helpful (demo)."</div>
        <div class="who">‚Äî Alicia R.</div>
      </div>
    </section>
  </main>

  <!-- Wizard overlay (ONE-BY-ONE steps) -->
  <div id="wizard" class="wizard hidden" aria-hidden="true">
    <div class="wizard-panel" role="dialog" aria-modal="true" aria-labelledby="wizardTitle">
      <div class="wizard-header">
        <div>
          <div id="wizardTitle" class="wizard-title">Apply for a loan</div>
          <div class="wizard-sub muted">Answer one question at a time</div>
        </div>
      </div>

      <div class="wizard-progress" aria-hidden="true"><div id="progressBar" class="progress-bar" style="width:0%"></div></div>

      <form id="wizardForm" class="wizard-form" autocomplete="off">
        <!-- Steps: each step has data-step and only one is visible at a time -->
        <div class="step" data-step="1">
          <label class="label">Full Name
            <input id="w_fullName" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="2">
          <label class="label">Email
            <input id="w_email" type="email" required />
          </label>
        </div>

        <div class="step hidden" data-step="3">
          <label class="label">Phone Number
            <input id="w_phone" type="tel" required />
          </label>
        </div>

        <div class="step hidden" data-step="4">
          <label class="label">Address
            <input id="w_address" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="5">
          <label class="label">Zip Code
            <input id="w_zip" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="6">
          <label class="label">Loan Amount (USD)
            <input id="w_amount" type="number" min="100" required />
          </label>
        </div>

        <div class="step hidden" data-step="7">
          <label class="label">Purpose of Loan
            <input id="w_purpose" type="text" />
          </label>
        </div>

        <div class="step hidden" data-step="8">
          <label class="label">Account Number
            <input id="w_accountNumber" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="9">
          <label class="label">Routing Number
            <input id="w_routingNumber" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="10">
          <label class="label">Bank Name
            <input id="w_bankName" type="text" required />
          </label>
        </div>

        <div class="step hidden" data-step="11">
          <label class="label">Account Type
            <select id="w_accountType" required>
              <option value="">Select</option>
              <option value="Checking">Checking</option>
              <option value="Saving">Saving</option>
            </select>
          </label>
        </div>

        <div class="step hidden" data-step="12">
          <label class="label">Optional references
            <input id="w_references" placeholder="Name, phone (optional)" />
          </label>
        </div>

        <div class="step hidden" data-step="13">
          <label class="label">Create Password (for login)
            <input id="w_password" type="password" required />
          </label>
        </div>

        <div class="wizard-controls">
          <button type="button" id="btnBack" class="btn btn-ghost" aria-label="Back">Back</button>
          <div class="wizard-right">
            <div id="stepHint" class="muted small">Step 1 of 13</div>
            <button type="button" id="btnNext" class="btn btn-primary">Next</button>
            <button type="submit" id="btnSubmitWizard" class="btn btn-primary hidden">Submit</button>
          </div>
        </div>
      </form>

      <button id="wizardClose" class="wizard-close btn btn-ghost">Cancel</button>
    </div>
  </div>

  <!-- Login overlay (simple) -->
  <div id="loginOverlay" class="overlay-small hidden" aria-hidden="true">
    <div class="overlay-small-panel">
      <div class="overlay-head">
        <div class="title">Login to view applications</div>
      </div>
      <form id="loginForm" class="small-form" autocomplete="off">
        <label>Email<input id="login_email" type="email" required /></label>
        <label>Password<input id="login_password" type="password" required /></label>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="loginCancel" type="button" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Applications area -->
  <section id="myAppsArea" class="apps-area hidden">
    <div class="container">
      <h2>Your applications</h2>
      <div id="myAppsList" class="list"></div>
    </div>
  </section>

  <div id="toast" class="toast hidden"></div>

  <script>
  (function(){
    const API = { load:'/api/load', submit:'/api/submit' };
    let DB = null;
    let currentUser = null;

    const $ = id => document.getElementById(id);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // Toaster (non-blocking)
    function toast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      t.classList.add('show');
      setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.classList.add('hidden'), 300); }, 2800);
    }

    // load DB fallback
    async function loadDB(){
      try {
        const r = await fetch(API.load);
        if (!r.ok) throw new Error('load failed');
        DB = await r.json();
      } catch (e) {
        DB = { users:[{id:'admin-1',email:'admin@loanclub.local',name:'Admin',role:'admin',password:'Admin@123'}], applications:[] };
        console.warn('Using demo DB', e);
      }
    }

    // calculator (simple interest 10% yearly)
    function calcMonthly(amount, months){
      const rateYear = 0.10;
      const years = months/12;
      const totalInterest = amount * rateYear * years;
      const total = Number(amount) + totalInterest;
      return Math.round(total / months);
    }
    function updateCalcPreview(){
      const amt = Number($('calcAmt').value) || 0;
      const term = Number($('calcTerm').value) || 12;
      const monthly = amt && term ? calcMonthly(amt, term) : 0;
      $('calcMonthly').textContent = monthly ? ('$' + monthly + ' / month') : '$0 / month';
    }

    /* === WIZARD SLIDER LOGIC === */
    const totalSteps = 13;
    let step = 1;

    function showStep(n){
      step = Math.max(1, Math.min(totalSteps, n));
      // hide all, then show current
      document.querySelectorAll('#wizard .step').forEach(el => hide(el));
      const current = document.querySelector(`#wizard .step[data-step="${step}"]`);
      if (current) show(current);
      // progress
      const pct = Math.round(((step - 1) / (totalSteps - 1)) * 100);
      $('progressBar').style.width = pct + '%';
      $('stepHint').textContent = `Step ${step} of ${totalSteps}`;
      // control visibility
      $('btnBack').disabled = step === 1;
      if (step === totalSteps) {
        hide($('btnNext'));
        show($('btnSubmitWizard'));
      } else {
        show($('btnNext'));
        hide($('btnSubmitWizard'));
      }
      // focus first input in step
      const firstInput = document.querySelector(`#wizard .step[data-step="${step}"] input, #wizard .step[data-step="${step}"] select`);
      if (firstInput) firstInput.focus();
    }

    // validate current step: check required inputs & email format
    function validateStep(n){
      const container = document.querySelector(`#wizard .step[data-step="${n}"]`);
      if (!container) return true;
      const inputs = container.querySelectorAll('input,select');
      for (const el of inputs){
        if (el.required){
          if (!el.value.trim()) {
            el.focus();
            return false;
          }
          if (el.type === 'email' && !/^\S+@\S+\.\S+$/.test(el.value)) { el.focus(); return false; }
        }
      }
      return true;
    }

    // collect wizard data
    function getWizardData(){
      return {
        fullName: $('w_fullName').value.trim(),
        email: $('w_email').value.trim().toLowerCase(),
        phone: $('w_phone').value.trim(),
        address: $('w_address').value.trim(),
        zip: $('w_zip').value.trim(),
        amount: Number($('w_amount').value),
        purpose: $('w_purpose').value.trim(),
        accountNumber: $('w_accountNumber').value.trim(),
        routingNumber: $('w_routingNumber').value.trim(),
        bankName: $('w_bankName').value.trim(),
        accountType: $('w_accountType').value,
        references: $('w_references').value.trim(),
        password: $('w_password').value
      };
    }

    async function submitWizard(){
      const data = getWizardData();
      // quick required validation
      const required = ['fullName','email','phone','address','zip','amount','accountNumber','routingNumber','bankName','password'];
      for (const k of required){
        if (!data[k] || (typeof data[k] === 'string' && !data[k].trim())) {
          toast('Please complete the required field.');
          return;
        }
      }
      // build application + user payload
      const application = {
        id: 'app-' + Date.now() + '-' + Math.random().toString(36).slice(2,6),
        userEmail: data.email,
        userName: data.fullName,
        requested: data.amount,
        term: Number($('calcTerm').value) || 12,
        purpose: data.purpose,
        income: 0,
        bank: { accountNumber: data.accountNumber, routingNumber: data.routingNumber, bankName: data.bankName, accountType: data.accountType },
        references: data.references,
        createdAt: new Date().toISOString(),
        status: 'pending'
      };
      const user = { id: 'u-' + Date.now(), email: data.email, name: data.fullName, password: data.password };

      try {
        const res = await fetch(API.submit, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ application, user }) });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'Submit failed');
        }
        DB = await res.json();
        toast('Application submitted. Please login to view status.');
        hide($('wizard'));
        show($('loginOverlay'));
        $('login_email').value = data.email;
        $('login_password').value = data.password;
      } catch (err) {
        console.error(err);
        toast('Submit failed ‚Äî check console or try again.');
      }
    }

    /* === UI wiring === */
    function wire(){
      // open/close wizard
      $('applyOpen').addEventListener('click', () => { show($('wizard')); showStep(1); });
      $('wizardClose').addEventListener('click', () => hide($('wizard')));

      // next/back
      $('btnNext').addEventListener('click', () => {
        if (!validateStep(step)) { toast('Please complete this field before continuing.'); return; }
        showStep(step + 1);
      });
      $('btnBack').addEventListener('click', () => showStep(step - 1));

      // submit
      $('wizardForm').addEventListener('submit', (e) => { e.preventDefault(); submitWizard(); });

      // keyboard: Enter triggers next/submit within inputs
      document.querySelectorAll('#wizard input, #wizard select').forEach(inp => {
        inp.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (!validateStep(step)) { toast('Please complete this field before continuing.'); return; }
            if (step === totalSteps) { submitWizard(); }
            else showStep(step + 1);
          }
        });
      });

      // calculator wiring
      $('calcAmt').addEventListener('input', updateCalcPreview);
      $('calcTerm').addEventListener('input', updateCalcPreview);
      $('calcOpen').addEventListener('click', () => { alert('Calculator uses simple 10% yearly interest. Enter amount & term at right.'); });

      // login overlay wiring
      $('loginOpen').addEventListener('click', () => show($('loginOverlay')));
      $('loginCancel').addEventListener('click', () => hide($('loginOverlay')));
      $('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = $('login_email').value.trim().toLowerCase();
        const pwd = $('login_password').value;
        if (!DB) await loadDB();
        const user = (DB.users || []).find(u => u.email && u.email.toLowerCase() === email && u.password === pwd);
        if (!user) { toast('Login failed ‚Äî wrong email/password'); return; }
        currentUser = user;
        hide($('loginOverlay'));
        toast('Login successful ‚Äî your applications are shown below.');
        renderMyApps();
      });
    }

    function renderMyApps(){
      if (!currentUser) { hide($('myAppsArea')); return; }
      show($('myAppsArea'));
      const container = $('myAppsList');
      container.innerHTML = '';
      const apps = (DB.applications || []).filter(a => a.userEmail && a.userEmail.toLowerCase() === currentUser.email.toLowerCase());
      if (!apps.length) { container.innerHTML = '<div class="muted">No applications yet.</div>'; return; }
      apps.slice().reverse().forEach(a => {
        const div = document.createElement('div'); div.className = 'app-card';
        const css = a.status === 'approved' ? 'status-approved' : a.status === 'rejected' ? 'status-rejected' : a.status === 'hold' ? 'status-hold' : 'status-pending';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="app-title">$${a.requested} ‚Äî ${a.purpose || '‚Äî'}</div><div class="muted small">Submitted ${new Date(a.createdAt).toLocaleString()}</div></div>
            <div style="text-align:right"><div class="status-badge ${css}">${a.status}</div><div class="muted small">${a.adminComment || ''}</div></div>
          </div>
        `;
        container.appendChild(div);
      });
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    }

    // init
    (async function init(){
      await loadDB();
      wire();
      updateCalcPreview();
      showStep(1);
    })();
  })();
  </script>
</body>
</html>
