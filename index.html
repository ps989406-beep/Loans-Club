<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Club — Apply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">LC</div>
      <div class="brand-name">Loan Club</div>
    </div>
    <nav class="nav-right">
      <button id="btn-view-login" class="btn btn-ghost">Login / Signup</button>
      <a href="/admin.html" class="admin-link" title="Admin (separate)">Admin →</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero card">
      <div class="hero-left">
        <h1>Loans made simple</h1>
        <p class="muted">Fast online applications, clear status tracking.</p>
        <div class="row">
          <button id="btn-start" class="btn btn-primary">Apply Now</button>
          <button id="btn-export" class="btn btn-outline">Export Data</button>
        </div>
      </div>
      <div class="hero-right">
        <div class="kpi">
          <div class="kpi-number">Demo</div>
          <div class="kpi-label">Loan Club</div>
        </div>
      </div>
    </section>

    <section id="auth" class="card hidden">
      <h2 id="auth-title">Login</h2>
      <form id="auth-form" class="form-grid" autocomplete="off">
        <input id="name" placeholder="Full name (signup only)" />
        <input id="email" placeholder="Email" required />
        <input id="password" type="password" placeholder="Password" required />
        <div class="row" style="margin-top:8px">
          <button type="submit" class="btn btn-primary" id="auth-submit">Login</button>
          <button id="auth-switch" type="button" class="btn btn-ghost">Switch to Signup</button>
        </div>
      </form>
      <div id="auth-msg" class="muted"></div>
    </section>

    <section id="dashboard" class="card hidden">
      <div class="dash-top row" style="justify-content:space-between;align-items:center">
        <h2>Your Applications</h2>
        <div id="user-info" class="muted"></div>
      </div>

      <div id="apply-card" class="card small">
        <h3>Apply for Loan</h3>
        <form id="loan-form" class="form-grid">
          <input id="loan-amount" placeholder="Loan amount (USD)" required />
          <input id="loan-term" placeholder="Term (months)" />
          <input id="loan-purpose" placeholder="Purpose" />
          <input id="loan-income" placeholder="Annual income" />
          <div class="row" style="justify-content:flex-end">
            <button type="submit" class="btn btn-primary">Submit Application</button>
          </div>
        </form>
      </div>

      <div id="applications-list" class="list"></div>
    </section>
  </main>

  <script>
  // inline app.js — customer logic (no modals)
  const API = { load: '/api/load', submit: '/api/submit' };
  let DB = null;
  let currentUser = null;

  // helpers
  const uid = (p='u') => p + '-' + Math.random().toString(36).slice(2,9);
  const byId = id => document.getElementById(id);

  // load DB
  async function loadData() {
    const res = await fetch(API.load);
    if (!res.ok) throw new Error('Load failed');
    DB = await res.json();
    renderAll();
  }

  // submit application (server appends)
  async function submitApplication(app) {
    const res = await fetch(API.submit, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ application: app })
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Submit failed');
    }
    DB = await res.json();
    renderAll();
  }

  // render
  function renderAll() {
    if (!DB) return;
    renderApplications();
  }
  function renderApplications() {
    const list = byId('applications-list');
    list.innerHTML = '';
    if (!currentUser) {
      list.innerHTML = '<div class="muted">Please login to view your applications.</div>';
      return;
    }
    const apps = DB.applications.filter(a => a.userId === currentUser.id);
    if (!apps.length) list.innerHTML = '<div class="muted">No applications yet.</div>';
    apps.forEach(a => {
      const d = document.createElement('div');
      d.className = 'app-card';
      const statusCls = a.status === 'approved' ? 'status-approved' : a.status === 'rejected' ? 'status-rejected' : a.status === 'hold' ? 'status-hold' : 'status-pending';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between">
          <div><strong>Requested: $${a.requested}</strong><div class="muted">Purpose: ${a.purpose||'—'}</div></div>
          <div><span class="status-badge ${statusCls}">${a.status}</span></div>
        </div>
        <div class="muted" style="margin-top:8px">Admin comment: ${a.adminComment||'—'}</div>
      `;
      if (a.status === 'approved' && !a.withdrawalRequested) {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerText = 'Withdraw (simulate)';
        btn.onclick = () => {
          const ok = confirm(`Request withdrawal for $${a.requested}?`);
          if (!ok) return;
          a.withdrawalRequested = true;
          a.withdrawalAt = new Date().toISOString();
          alert('Withdrawal requested. Admin will process it in the admin dashboard.');
          renderAll();
        };
        d.appendChild(btn);
      }
      list.appendChild(d);
    });
  }

  // auth & forms
  function setupAuth(){
    byId('btn-start').onclick = () => { byId('hero')?.classList?.add?.('hidden'); byId('auth').classList.remove('hidden'); };
    let signup = false;
    byId('auth-switch').onclick = () => {
      signup = !signup;
      byId('auth-title').innerText = signup ? 'Signup' : 'Login';
      byId('auth-submit').innerText = signup ? 'Signup' : 'Login';
      byId('name').style.display = signup ? 'block' : 'none';
    };
    byId('auth-form').onsubmit = async e => {
      e.preventDefault();
      const email = byId('email').value.trim();
      const pass = byId('password').value.trim();
      const name = byId('name').value.trim() || email;
      if (signup) {
        if (DB.users.find(u => u.email === email)) { byId('auth-msg').innerText = 'Email exists'; return; }
        const id = uid('u');
        const u = { id, email, name, role:'user', password: pass };
        DB.users.push(u);
        currentUser = u;
        alert('Signed up locally. Export data to persist, or ask admin to import.');
        showDashboard();
      } else {
        const found = DB.users.find(u => u.email === email && u.password === pass);
        if (!found) { byId('auth-msg').innerText = 'Wrong credentials'; return; }
        currentUser = found;
        showDashboard();
      }
    };
  }
  function showDashboard(){
    byId('auth').classList.add('hidden');
    byId('dashboard').classList.remove('hidden');
    byId('user-info').innerText = `${currentUser.name} (${currentUser.email})`;
  }

  function setupLoanForm(){
    byId('loan-form').onsubmit = async e => {
      e.preventDefault();
      if (!currentUser) return alert('Please login');
      const requested = byId('loan-amount').value.trim();
      const purpose = byId('loan-purpose').value.trim();
      const term = byId('loan-term').value.trim();
      const income = byId('loan-income').value.trim();
      const app = { id: uid('app'), userId: currentUser.id, userName: currentUser.name, requested, term, purpose, income, status:'pending' };
      try {
        await submitApplication(app);
        byId('loan-form').reset();
        alert(`Your application for $${requested} was submitted.`);
      } catch (err) {
        alert('Submit failed: ' + (err.message || err));
      }
    };
  }

  function setupExport(){
    byId('btn-export').onclick = () => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(DB, null, 2)], {type:'application/json'}));
      a.download = 'loanclub-data.json';
      a.click();
    };
  }

  // wire
  (async function(){
    setupAuth();
    setupLoanForm();
    setupExport();
    document.getElementById('btn-view-login').onclick = () => document.getElementById('auth').classList.toggle('hidden');
    try { await loadData(); } catch(e) { DB = {meta:{brand:'Loan Club'}, users:[{id:'admin-1',email:'admin@loanclub.local',name:'Admin',role:'admin',password:'Admin@123'}], applications:[]}; renderAll(); }
  })();
  </script>
</body>
</html>
