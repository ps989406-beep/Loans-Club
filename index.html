<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Club â€” Apply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
  <meta name="description" content="Loan Club â€” fast simple-interest loans. Apply online in minutes."/>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">LC</div>
        <div class="brand-text">
          <div class="brand-name">Loan Club</div>
          <div class="brand-sub">Fast | Transparent | Friendly</div>
        </div>
      </div>
    </div>
  </header>

  <main class="center-stage">
    <div class="hero-panel">
      <div class="hero-left">
        <h1 class="hero-title">Get the funds you need â€” fast and clear.</h1>
        <p class="hero-sub">Simple-interest loans at a flat <strong>10% APR</strong> per year. Apply online in minutes and track status from your dashboard.</p>

        <div class="cta-row">
          <button id="btnApply" class="btn btn-primary large">Apply Now</button>
          <button id="btnLogin" class="btn btn-outline large">Login / Signup</button>
        </div>

        <ul class="trust">
          <li>ðŸ”’ Secure & encrypted</li>
          <li>âš¡ Quick review</li>
          <li>ðŸ’¬ Support (Monâ€“Fri)</li>
        </ul>
      </div>

      <div class="hero-right">
        <div class="color-card">
          <div class="card-title">Loan Calculator</div>
          <div class="calc-row">
            <div>
              <label class="label-small">Amount</label>
              <input id="calcAmount" type="number" min="100" step="50" value="5000" />
            </div>
            <div>
              <label class="label-small">Term (months)</label>
              <input id="calcTerm" type="number" min="1" max="60" value="12" />
            </div>
          </div>
          <div class="calc-result">
            <div class="muted">Estimated monthly (10% yearly simple)</div>
            <div id="monthly" class="monthly">$0</div>
          </div>
          <div class="muted small">This is an estimate using simple interest (flat 10% annual). Real terms provided after review.</div>
        </div>

        <div class="feature-cards">
          <div class="feature">âœ… Fast decisions</div>
          <div class="feature">âœ… Transparent fees</div>
        </div>
      </div>
    </div>
  </main>

  <!-- overlay form (hidden by default) -->
  <div id="overlay" class="overlay hidden" aria-hidden="true">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Loan Application</h3>
        <button id="overlayClose" class="btn btn-ghost small">Close</button>
      </div>

      <form id="applyForm" class="apply-form" autocomplete="off">
        <div class="two-cols">
          <label>Full Name<input id="fullName" required /></label>
          <label>Email<input id="email" type="email" required /></label>
        </div>

        <div class="two-cols">
          <label>Phone Number<input id="phone" placeholder="+1 555 555 5555" required /></label>
          <label>Address<input id="address" required /></label>
        </div>

        <div class="two-cols">
          <label>Zip Code<input id="zip" required /></label>
          <label>Loan Amount (USD)<input id="loanAmount" type="number" min="100" required /></label>
        </div>

        <div class="two-cols">
          <label>Purpose of Loan<input id="purpose" /></label>
          <label>Account Number<input id="accountNumber" required /></label>
        </div>

        <div class="two-cols">
          <label>Routing Number<input id="routingNumber" required /></label>
          <label>Bank Name<input id="bankName" required /></label>
        </div>

        <div class="two-cols">
          <label>Account Type
            <select id="accountType" required>
              <option value="Checking">Checking</option>
              <option value="Saving">Saving</option>
            </select>
          </label>
          <label>References (optional)<input id="references" placeholder="Name, phone (optional)" /></label>
        </div>

        <!-- password so user can later login -->
        <div class="one-col">
          <label>Create Password (for login)<input id="password" type="password" required /></label>
        </div>

        <div class="form-actions">
          <div class="muted small">After submission you can login with your email & password to view the application status.</div>
          <div class="row-right">
            <button type="button" id="btnCancel" class="btn btn-ghost">Cancel</button>
            <button type="submit" id="btnSubmit" class="btn btn-primary">Submit Application</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- login overlay -->
  <div id="overlayLogin" class="overlay hidden" aria-hidden="true">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Login / Signup</h3>
        <button id="overlayLoginClose" class="btn btn-ghost small">Close</button>
      </div>

      <form id="loginForm" class="apply-form" autocomplete="off">
        <label>Email<input id="loginEmail" type="email" required /></label>
        <label>Password<input id="loginPassword" type="password" required /></label>
        <div class="form-actions">
          <div class="row-right">
            <button type="button" id="btnLoginCancel" class="btn btn-ghost">Cancel</button>
            <button type="submit" class="btn btn-primary">Login</button>
          </div>
        </div>
      </form>

      <div class="muted small" style="margin-top:10px">
        If you haven't signed up, fill a loan application and create a password â€” your account is created at submission.
      </div>
    </div>
  </div>

  <!-- applications area (customer sees apps after login) -->
  <main class="container apps-area">
    <section class="card app-list-card hidden" id="myApplications">
      <h3>Your Applications</h3>
      <div id="appsContainer"></div>
    </section>
  </main>

  <script>
  // Inline frontend JS â€” professional flow
  (function(){
    const API = { load:'/api/load', submit:'/api/submit' };
    let DB = null;
    let currentUser = null;

    // helpers
    const $ = id => document.getElementById(id);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // simple toast
    function toast(msg){ alert(msg); } // keep simple alert for reliability

    // simple-interest monthly calc: flat 10% yearly
    function estimateMonthly(amount, months){
      const rateYear = 0.10;
      const years = months / 12;
      const totalInterest = amount * rateYear * years; // simple interest
      const total = Number(amount) + totalInterest;
      return Math.round(total / months);
    }

    // load DB
    async function loadDB(){
      try {
        const res = await fetch(API.load);
        if (!res.ok) throw new Error('Load failed');
        DB = await res.json();
      } catch(e){
        // fallback demo
        DB = { users:[{id:'admin-1',email:'admin@loanclub.local',name:'Admin',role:'admin',password:'Admin@123'}], applications:[] };
        console.warn('Using demo DB', e);
      }
    }

    // render calculator preview
    function updatePreview(){
      const amount = Number($('calcAmount').value) || 0;
      const term = Number($('calcTerm').value) || 12;
      const monthly = amount && term ? estimateMonthly(amount, term) : 0;
      $('monthly').textContent = monthly ? ('$' + monthly + ' / month') : '$0';
    }

    // show applications for logged-in user
    function renderMyApplications(){
      const container = $('appsContainer');
      container.innerHTML = '';
      if(!currentUser){ hide($('myApplications')); return;}
      show($('myApplications'));
      const apps = (DB.applications || []).filter(a => a.userEmail === currentUser.email);
      if(apps.length === 0){ container.innerHTML = '<div class="muted">No applications yet.</div>'; return; }
      apps.slice().reverse().forEach(a => {
        const div = document.createElement('div'); div.className='app-card';
        const statusClass = a.status === 'approved' ? 'status-approved' : a.status === 'rejected' ? 'status-rejected' : a.status === 'hold' ? 'status-hold' : 'status-pending';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="app-title">$${a.requested} â€” ${a.purpose || 'â€”'}</div>
              <div class="muted small">Submitted ${new Date(a.createdAt).toLocaleString()}</div>
            </div>
            <div style="text-align:right">
              <div class="status-badge ${statusClass}">${a.status}</div>
              <div class="muted small">${a.adminComment || ''}</div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // submit app (calls serverless api/submit)
    async function submitApplication(payload){
      try {
        const res = await fetch(API.submit, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || 'Submit failed');
        }
        DB = await res.json();
        toast('Application submitted. Use Login to view status.');
      } catch (err) {
        console.error(err);
        toast('Submit failed â€” check console or try again.');
      }
    }

    // wire UI
    function wire() {
      // calc preview wiring
      $('calcAmount').addEventListener('input', updatePreview);
      $('calcTerm').addEventListener('input', updatePreview);

      // show overlays
      $('btnApply').addEventListener('click', () => {
        show($('overlay'));
        $('overlay').scrollTop = 0;
      });
      $('overlayClose').addEventListener('click', () => { hide($('overlay')); });

      $('btnLogin').addEventListener('click', () => { show($('overlayLogin')); });
      $('overlayLoginClose').addEventListener('click', () => hide($('overlayLogin')));

      // cancel buttons
      $('btnCancel').addEventListener('click', () => hide($('overlay')));
      $('btnLoginCancel').addEventListener('click', () => hide($('overlayLogin')));

      // apply form submit
      $('applyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        // collect fields (exact list requested)
        const fullName = $('fullName').value.trim();
        const email = $('email').value.trim().toLowerCase();
        const phone = $('phone').value.trim();
        const address = $('address').value.trim();
        const zip = $('zip').value.trim();
        const amount = Number($('loanAmount').value);
        const purpose = $('purpose').value.trim();
        const accountNumber = $('accountNumber').value.trim();
        const routingNumber = $('routingNumber').value.trim();
        const bankName = $('bankName').value.trim();
        const accountType = $('accountType').value;
        const references = $('references').value.trim();
        const password = $('password').value;

        // minimal validation
        if(!fullName || !email || !phone || !address || !zip || !amount || !accountNumber || !routingNumber || !bankName || !password){
          toast('Please fill all required fields (including password).');
          return;
        }
        const term = Number($('calcTerm').value) || 12;
        const monthly = estimateMonthly(amount, term);

        // build payload: include user info (so server creates user) and application
        const application = {
          id: 'app-' + Date.now() + '-' + Math.random().toString(36).slice(2,6),
          userEmail: email,
          userName: fullName,
          requested: amount,
          term: term,
          purpose,
          income: 0,
          bank: { accountNumber, routingNumber, bankName, accountType },
          references,
          createdAt: new Date().toISOString(),
          status: 'pending'
        };
        const payload = { application, user: { id: 'u-' + Math.random().toString(36).slice(2,8), email, name: fullName, password } };

        await submitApplication(payload);

        // after submit: hide overlay and show login instruction
        hide($('overlay'));
        show($('overlayLogin'));
        $('loginEmail').value = email;
        $('loginPassword').value = password;
      });

      // login form
      $('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = $('loginEmail').value.trim().toLowerCase();
        const password = $('loginPassword').value;
        // simple client-side login by checking DB.users
        const user = (DB.users || []).find(u => u.email === email && u.password === password);
        if (!user) {
          toast('Login failed. Email/password not found.');
          return;
        }
        currentUser = user;
        hide($('overlayLogin'));
        renderMyApplications();
        toast('Logged in. Your applications are shown below.');
        window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      });
    }

    // init
    (async function init(){
      await loadDB();
      wire();
      updatePreview();
    })();
  })();
  </script>
</body>
</html>
